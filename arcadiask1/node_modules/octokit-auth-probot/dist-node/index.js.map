{"version":3,"file":"index.js","sources":["../dist-src/auth.js","../dist-src/get-state.js","../dist-src/version.js","../dist-src/index.js"],"sourcesContent":["import { createUnauthenticatedAuth } from \"@octokit/auth-unauthenticated\";\nexport async function auth(state, options) {\n    // return authentication from internal auth instance unless the event is \"event-octokit\"\n    if (options.type !== \"event-octokit\") {\n        if (state.type === \"token\" &&\n            options.type === \"installation\" &&\n            options.factory) {\n            const { type, factory, ...factoryAuthOptions } = options;\n            return factory(\n            // @ts-ignore factory options differ if internal auth type is token\n            Object.assign({}, factoryAuthOptions, {\n                octokit: state.octokit,\n                octokitOptions: state.octokitOptions,\n            }));\n        }\n        return state.auth(options);\n    }\n    // unless the internal event type is \"app\", return the octokit\n    // instance passed as strategy option\n    if (state.type !== \"app\") {\n        return state.octokit;\n    }\n    const action = options.event.payload.action;\n    const installationId = options.event.payload.installation && options.event.payload.installation.id;\n    const fullEventName = options.event.name + (action ? \".\" + action : \"\");\n    const OctokitWithEventAuth = state.octokit\n        .constructor;\n    if (!installationId) {\n        const { auth, ...octokitOptions } = state.octokitOptions;\n        return new OctokitWithEventAuth({\n            authStrategy: createUnauthenticatedAuth,\n            auth: {\n                reason: `Handling a \"${fullEventName}\" event: an \"installation\" key is missing. The installation ID cannot be determined`,\n            },\n            ...octokitOptions,\n        });\n    }\n    if (options.event.name === \"installation\" &&\n        [\"suspend\", \"deleted\"].includes(String(action))) {\n        const { auth, ...octokitOptions } = state.octokitOptions;\n        return new OctokitWithEventAuth({\n            authStrategy: createUnauthenticatedAuth,\n            auth: {\n                reason: `Handling a \"${fullEventName}\" event: The app's access has been revoked from @octokit (id: ${installationId})`,\n            },\n            ...octokitOptions,\n        });\n    }\n    // otherwise create a pre-authenticated (or unauthenticated) Octokit instance\n    // depending on the event payload\n    return state.auth({\n        type: \"installation\",\n        installationId,\n        factory: (auth) => {\n            const options = Object.assign({}, state.octokitOptions, {\n                auth: Object.assign({}, auth, {\n                    installationId,\n                }),\n            });\n            return new OctokitWithEventAuth(options);\n        },\n    });\n}\n","import { createTokenAuth } from \"@octokit/auth-token\";\nimport { createAppAuth } from \"@octokit/auth-app\";\nimport { createUnauthenticatedAuth } from \"@octokit/auth-unauthenticated\";\nexport function getState(options) {\n    const common = {\n        octokit: options.octokit,\n        octokitOptions: options.octokitOptions,\n    };\n    if (\"token\" in options) {\n        return {\n            type: \"token\",\n            auth: createTokenAuth(String(options.token)),\n            ...common,\n        };\n    }\n    if (\"appId\" in options && \"privateKey\" in options) {\n        return {\n            type: \"app\",\n            auth: createAppAuth(options),\n            ...common,\n        };\n    }\n    return {\n        type: \"unauthenticated\",\n        auth: createUnauthenticatedAuth({\n            reason: `Neither \"appId\"/\"privateKey\" nor \"token\" have been set as auth options`,\n        }),\n        ...common,\n    };\n}\n","export const VERSION = \"0.0.0-development\";\n","import { auth } from \"./auth\";\nimport { getState } from \"./get-state\";\nimport { VERSION } from \"./version\";\nexport function createProbotAuth(options) {\n    const state = getState(options);\n    return Object.assign(auth.bind(null, state), {\n        hook: state.auth.hook,\n    });\n}\ncreateProbotAuth.VERSION = VERSION;\n"],"names":["auth","state","options","type","factory","factoryAuthOptions","Object","assign","octokit","octokitOptions","action","event","payload","installationId","installation","id","fullEventName","name","OctokitWithEventAuth","constructor","authStrategy","createUnauthenticatedAuth","reason","includes","String","getState","common","createTokenAuth","token","createAppAuth","VERSION","createProbotAuth","bind","hook"],"mappings":"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"}